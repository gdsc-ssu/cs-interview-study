# 2.2 TCP/IP 4계층 모델

## 2.2.1 계층 구조

- 특정 계층의 변경이 다른 계층에 영향 X

| **TCP/IP** | **OSI 7계층** |
|---|---|
| 애플리케이션 <br> <br> <br> 전송 <br> 인터넷 <br> 링크 <br> <br> | 애플리케이션 <br> 프레젠테이션 <br> 세션 <br> 전송 <br> 네트워크 <br> 데이터 링크 <br> 물리 |

### 애플리케이션(Application) 계층

- 응용프로그램이 사용되는 프로토콜 계층
- 웹서비스, 이메일 등 서비스를 실질적으로 제공
- 예시: FTP, SSH, HTTP, SMTP, DNS 등

### 전송(Transport) 계층

- 송신자와 수신자를 연결하는 통신 서비스 제공
- 연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어 제공
- 애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할
- ex. TCP, UDP

 **TCP** | **UDP** |
|---|---|
| 순서 보장 O | 순서 보장 X |
| 수신 여부 확인 O | 수신 여부 확인 X |
| 연결지향 프로토콜 => 신뢰성 |   |
| 가상회선 패킷 교환 방식 | 데이터그램 패킷 교환 방식 |

#### 가상회선 패킷 교환 방식

- 각 패킷에 가상회선 식별자 포함
- 모든 패킷을 전송하면 가상회선이 해제됨
- 순서 보장

#### 데이터그램 패킷 교환 방식

- 패킷이 독립적으로 이동하며 최적의 경로 선택
- 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있음
- 순서 보장 X

#### TCP 연결 성립 과정

**3-way handshake** => 신뢰성 확보

1. SYN (클라이언트 -> 서버)
    - 클라이언트가 서버로 클라이언트의 ISN을 담아 SYN 보냄
    - ISN: 새로운 TCP 연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호 (장치마다 다를 수 있음)
2. SYN + ACK (서버 -> 클라이언트)
    - 서버가 클라이언트의 SYN 수신
    - 서버가 서버의 ISN과 승인번호를 클라이언트로 보냄
    - 승인번호는 클라이언트 ISN + 1
3. ACK (클라이언트 -> 서버)
    - 클라이언트가 승인번호를 서버로 보냄
    - 승인번호는 서버 ISN + 1

#### TCP 연결 해제 과정

**4-way handshake**

1. FIN (클라이언트 -> 서버)
    - 클라이언트가 서버로 FIN으로 설정된 세그먼트 전송
    - 클라이언트는 FIN_WAIT_1 상태로 전환 & 서버의 응답을 기다림
2. ACK (서버 -> 클라이언트)
    - 서버가 클라이언트로 ACK(승인 세그먼트) 전송
    - 서버는 CLOSE_WAIT 상태로 전환
    - 클라이언트는 ACK 세그먼트를 받으면 FIN_WAIT_2 상태로 전환
3. FIN (서버 -> 클라이언트)
    - 서버가 2번 과정 후 일정 시간 이후에 클라이언트로 FIN 세그먼트 전송
4. ACK (클라이언트 -> 서버)
    - 클라이언트는 TIME_WAIT 상태로 전환
    - 클라이언트가 서버로 ACK 전송
    - 서버는 CLOSED 상태로 전환
    - 일정 시간 대기 후 연결 해제

- TIME_WAIT 이유 (일정 시간 대기한 후 해제하는 이유)
    - 지연 패킷으로 인한 무결성 문제 방지하기 위함
    - 두 장치가 연결이 닫혔는지 확인하기 위함 <br>
    (LAST_ACK 상태에서 닫히면 새로운 연결 시 접속 오류 발생)

### 인터넷 계층

- 장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사요ㅕㅇ
- IP, ARP, ICMP 등 존재
- 패킷을 수신 주소를 지정하여 데이터 전달
- 비연결형 (상대방이 제대로 받았는지에 대해 보장하지 않음)

### 링크 계층 (네트워크 접근 계층)

- 실질적으로 데이터를 전달하며 장치 간에 신호를 주고받는 '규칙'을 정하는 계층
- 물리 계층 + 데이터 링크 계층
    - 물리 계층: 무선 LAN과 유선 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층
    - 데이터링크 계층: '이더넷 프레임'을 통해 에러 확인, 흐름 제어, 접근 제어 담당

#### 유선 LAN (IEEE802.3)

- 유선 LAN을 이루는 이더넷은 IEEE802.3이라는 프로토콜을 따름
- 전이중화 통신 사용

##### 전이중화 통신

- 양쪽 장치가 동시에 송수신할 수 있는 방식 (충돌 방지 매커니즘 필요 X)
- 송신로와 수신로로 나눠서 데이터 교환
- 현대의 고속 이더넷이 통신하는 방식임

##### CSMA/CD

- 반이중화 통신 중 하나
- 수신로와 송신로 동일
- 데이터를 '보낸 이후' 충돌이 발생하면 일정 시간 이후 재전송
- 수신로와 송신로가 동일하기 때문에 데이터 충돌에 대비해야 함

#### 유선 LAN을 이루는 케이블

- 트위스트 페어 케이블 (TP 케이블) & 광섬유 케이블

##### 트위스트 페어 케이블

- 여덟 개의 구리선을 두 개씩 꼬아서 묶은 케이블
- UTP 케이블과 STP 케이블로 나눠짐
    - UTP 케이블: 구리선을 실드 처리하지 않고 덮음
    - STP 케이블: 구리선을 실드처리하고 덮음

##### 광섬유 케이블

- 레이저를 이용해 통신
- 장거리 및 고속 통신 가능
- 100Gbps의 데이터 전송
- 코어와 클래딩 부분으로 나뉨
    - 코어(core): 빛의 굴절률이 높은 부분
    - 클래딩(cladding): 빛의 굴절률이 낮은 부분

#### 무선 LAN(IEEE802.11)

- 수신과 송신에 같은 채널 사용
- 반이중화 통신 사용

##### 반이중화 통신 (half duplex)

- 양쪽 장치 서로 통신 가능 (동시 통신은 불가능)
- 장치가 신호를 수신하기 시작하면 전송이 완로된 후 응답 가능
- 둘 이상의 장치가 동시에 전송하면 충돌 발생 => 메시지 손실/왜곡 <br>
∴ 충돌 방지 시스템 필요

##### CSMA/CA

- 반이중화 통신 중 하나
- 데이터 전송 전 사전에 가능한 한 충돌 방지
- 과정
    1. 사용 중인 채널이 있다면 유후 상태인 채널 탐지
    2. IFS(프레임 간 공간) 시간만큼 기다림
    3. 프레임 전송 전 랜덤 상수(0 ~ 2^k - 1)를 기반으로 결정된 시간만큼 기다린 뒤 프레임 전송
        - 프레임을 보낸 후 ACK 세그먼트를 받았다면 마침
        - ACK 세그먼트를 받지 못했다면 k = k+1을 하며 이 과정 반복
        - k가 정해진 Kmax보다 더 커지면 해당 프레임 전송은 폐기 (abort)

#### 무선 LAN을 이루는 주파수

| 구분 | **2.4GHz** | **5GHz** |
| --- | --- | --- |
| 장점 | 장애물에 강함 | 사용할 수 있는 채널 수가 많고 동시 사용 가능 => 깨끗한 전파 환경 |
| 단점 | 전파 간섭 발생 | |

##### 와이파이

- 전자기기들이 무선 LAN 신호에 연결할 수 있게 하는 기술
- 무선 접속 장치 (공유기)가 이써야 함 (유선 LAN 신호를 무선 LAN 신호로 변환)

##### BSS (Basic Service Set)

- 기본 서비스 집합
- BSS 내에 있는 AP(무선 접속 장치)들과 장치들이 서로 통신이 가능한 구조
- 근거리 무선 통신 제공
- 하나의 AP만을 기반으로 구축 (한 장소에서만 이용 가능)

##### ESS (Extended Service Set)

- 하나 이상의 연결된 BSS 그룹
- 장거리 무선 통신 제공
- BSS보다 더 많은 가용성과 이동성 지원
- 한 장소에서 다른 장소로 이동하며 중단 없이 네트워크에 계속 연결 가능

#### 이더넷 프레임

- 데이터 링크 계층은 이더넷 프레임을 통해 전달받은 데이터의 에러 검출 및 캡슐화
- 구조
    - Preamble : 이더넷 프레임이 시작임을 알림
    - SFD : 다음 바이트부터 MAC 주소 필드가 시작됨을 알림)
    - DMAC : 수신 MAC 주소
    - MAC : 송신 MAC 주소
    - EtherType : IP 프로토콜 정의 (IPv4 or IPv6)
    - Payload : 전달받은 데이터
    - CRC : 에러 확인 비트

### 계층 간 데잍터 송수신 과정

- 애플리케이션 계층 -> 전송 계층 -> 인터넷 계층 -> 링크 계층 -> 링크 계층 -> 인터넷 계층 -> 전송 계층 -> 애플리케이션 계층 -> 서버

#### 캡슐화 과정

- 상위 계층의 헤더와 데이터를 하위 계층의 데이터 부분에 포함시키고, 해당 계층의 헤더를 삽입하는 과정
    - 메시지 -> 세그먼트/데이터그램 -> 패킷 -> 프레임
    - 애플리케이션 계층 -> 데이터 전송 계층 : TCP(L4) 헤더 추가 ('세그먼트' 또는 '데이터그램'화)
    - 데이터 전송 계층 -> 인터넷 계층 : IP(L3) 헤더 추가 ('패킷'화)
    - 인터넷 계층 -> 링크 계층 : 프레임 헤더와 프레임 트레일러 추가 ('프레임'화)

#### 비캡슐화 과정

- 하위 계층에서 상위 계층으로 가며 각 게층의 헤더 부분을 제거하는 과정
- 프레임화된 데이터 -> 패킷화 -> 세그먼트화/데이터그램화 -> 메시지화
- 최종적으로 사용자에게 애플리케이션의 PDU인 메시지로 전달

## 2.2.2 PDU (Protocol Data Unit)

네트워크 계층 간 데이터 전달 시 한 덩어리의 단위

- 애플리케이션 계층: 메시지
- 전송 계층: 세그먼트(TCP), 데이터그램(UDP)
- 인터넷 계층: 패킷
- 링크 계층: 프레임(데이터 링크 계층), 비트(물리 계층)

애플리케이션 계층에서 비트가 아닌 문자열 기반으로 송수신 하는 이유: 헤더에 authorization 값 등 다른 값을 넣는 확장이 쉽기 때문
